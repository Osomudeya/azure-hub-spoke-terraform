#!/bin/bash
# Automated setup script - Updated for modular architecture

set -e

echo "=================================================="
echo "Azure Hub-Spoke Assessment Setup"
echo "=================================================="
echo ""

# Check prerequisites
echo "Checking prerequisites..."

if ! command -v az &> /dev/null; then
    echo "âŒ Azure CLI not installed"
    exit 1
fi
echo "âœ… Azure CLI installed"

if ! command -v terraform &> /dev/null; then
    echo "âŒ Terraform not installed"
    exit 1
fi
echo "âœ… Terraform installed"

if ! command -v jq &> /dev/null; then
    echo "âš ï¸  jq not installed (recommended for output parsing)"
    echo "   Install with: brew install jq (macOS) or apt install jq (Ubuntu)"
fi

# Login to Azure
echo ""
echo "Checking Azure login..."
if az account show &> /dev/null; then
    SUBSCRIPTION=$(az account show --query name -o tsv)
    echo "âœ… Logged in to: $SUBSCRIPTION"
else
    echo "Please login to Azure:"
    az login
fi

# Generate SSH key
echo ""
echo "Setting up SSH key..."
SSH_KEY_PATH="$HOME/.ssh/azure_hubspoke_key"

if [ -f "$SSH_KEY_PATH" ]; then
    echo "âœ… SSH key already exists"
else
    echo "Generating SSH key..."
    ssh-keygen -t rsa -b 4096 -f "$SSH_KEY_PATH" -N ""
    echo "âœ… SSH key generated"
fi

# Get public IP
echo ""
echo "Getting your public IP..."
PUBLIC_IP=$(curl -s https://api.ipify.org)
if [ -n "$PUBLIC_IP" ]; then
    echo "âœ… Your public IP: $PUBLIC_IP"
else
    echo "âš ï¸  Could not detect IP automatically"
    read -p "Enter your public IP: " PUBLIC_IP
fi

# Create terraform.tfvars for modular architecture
echo ""
echo "Creating terraform.tfvars for modular architecture..."
SSH_PUBLIC_KEY=$(cat "${SSH_KEY_PATH}.pub")

cat > environments/dev/terraform.tfvars <<EOF
# Generated by setup script - Modular Architecture

# Resource Group Configuration  
resource_group_name = "rg-hubspoke-assessment"
location            = "East US"
prefix              = "demo"

# Hub Network Configuration
hub_vnet_address_space       = "10.0.0.0/16"
hub_subnet_address_prefix    = "10.0.1.0/24"

# Spoke 1 Network Configuration
spoke1_vnet_address_space    = "10.1.0.0/16"
spoke1_subnet_address_prefix = "10.1.1.0/24"

# Spoke 2 Network Configuration
spoke2_vnet_address_space    = "10.2.0.0/16"
spoke2_subnet_address_prefix = "10.2.1.0/24"

# Virtual Machine Configuration
vm_size        = "Standard_B1s"
admin_username = "azureuser"

# Security Configuration
ssh_public_key  = "${SSH_PUBLIC_KEY}"
admin_source_ip = "${PUBLIC_IP}/32"
EOF

echo "âœ… terraform.tfvars created"

# Initialize Terraform
echo ""
echo "Initializing Terraform with modular modules..."
cd environments/dev
terraform init
echo "âœ… Terraform initialized"

# Validate configuration
echo ""
echo "Validating modular configuration..."
terraform validate
echo "âœ… Configuration valid"

echo ""
echo "=================================================="
echo "âœ¨ Assessment Setup Complete!"
echo "=================================================="
echo ""
echo "ðŸ—ï¸  Modular Architecture Created:"
echo "   â€¢ resource-group module"
echo "   â€¢ hub-network module"  
echo "   â€¢ spoke-network module"
echo "   â€¢ vnet-peering module"
echo ""
echo "ðŸ“ Project Structure:"
echo "   modules/"
echo "   â”œâ”€â”€ resource-group/    # Shared foundation"
echo "   â”œâ”€â”€ hub-network/       # Central connectivity"
echo "   â”œâ”€â”€ spoke-network/     # Reusable workload template"
echo "   â””â”€â”€ vnet-peering/      # Bidirectional peering"
echo ""
echo "ðŸš€ Next steps:"
echo "1. Review: environments/dev/terraform.tfvars"
echo "2. Plan: terraform plan"
echo "3. Deploy: terraform apply"
echo "4. Test: ../../scripts/test-connectivity.sh"
echo ""
echo "ðŸŽ¯ Assessment Benefits:"
echo "   â€¢ Modular, reusable design"
echo "   â€¢ Clean separation of concerns"
echo "   â€¢ Easy to understand and maintain"
echo "   â€¢ Meets all assessment requirements"
echo ""